{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/user_profile_edit.css' %}">
<div class="profile-edit-container">
    <h2 class="form-title">Edit Profile</h2>
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Confirm Changes</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to save these changes?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmSave">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    <form method="post" class="profile-edit-form" id="profileEditForm">
        {% csrf_token %}
        <div class="form-section">
            {{ user_form.as_p }}
            <button type="button" class="btn btn-primary save-btn">Save Profile</button>
        </div>
        <div class="form-section">
            <h3>Change Password (Optional)</h3>
            <p>If you would like to change your password, enter the new password below. <br> Otherwise, leave "New Password" fields blank.</p>
            {{ password_form.as_p }}
            <button type="button" class="btn btn-primary change-password-btn">Change Password</button>
        </div>
    </form>
</div>

<script>
    $(document).ready(function() {
        var formAction = ''; // Track which action is being confirmed

        function validateAndHighlight() {
            var isValid = true;
            // Clear previous error messages
            $('.error-message').remove();
            $('.profile-edit-form').find('input[required], textarea[required], select[required]').each(function() {
                if ($(this).val() === '') {
                    $(this).addClass('is-invalid'); // Highlight fields that are required and empty
                    // Add an error message directly after the field
                    $('<div class="error-message text-danger">This field is required.</div>').insertAfter($(this));
                    isValid = false;
                } else {
                    $(this).removeClass('is-invalid');
                }
            });
            return isValid;
        }

        // Handle click on save profile button
        $('.save-btn').click(function() {
            if (validateAndHighlight()) {
                formAction = 'save_profile';
                $('#confirmationModal').modal('show');
            }
        });

        // Handle click on change password button
        $('.change-password-btn').click(function() {
            if (validateAndHighlight()) {
                formAction = 'change_password';
                $('#confirmationModal').modal('show');
            }
        });

        // Confirm button in modal
        $('#confirmSave').click(function() {
            if (formAction !== '') {
                $('<input>').attr({
                    type: 'hidden',
                    name: 'action',
                    value: formAction
                }).appendTo('#profileEditForm');
                $('#profileEditForm').submit();
            }
        });

        $('.profile-edit-form').find('input[required], textarea[required], select[required]').on('input', function() {
            $(this).removeClass('is-invalid');
            $(this).next('.error-message').remove(); 
        });
    });
</script>

{% endblock %}
